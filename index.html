<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Sharing dApp</title>
    <style>
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f9;
            color: #333;
        }
        h1, h2 {
            text-align: center;
            color: #444;
        }
        form, .section {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
        }
        #alias {
            display: block;
            width: 100%;
            padding-top: 10px;
            padding-bottom: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        input[type="text"], input[type="password"], input[type="file"], input[type="submit"], input[type="button"], button {
            display: block;
            width: 100%;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            padding-top: 10px;
            padding-bottom: 10px;
        }
        input[type="submit"], input[type="button"], button {
            background-color: #333;
            color: #fff;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        input[type="submit"]:hover, input[type="button"]:hover, button:hover {
            background-color: #555;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }
        li {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        audio {
            flex-grow: 1;
        }
        #add-file-section, #search-section, #pub-key-section, #your-files-section, #found-files-section {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Share Your Music</h1>

    <form id="sign">
        <input id="alias" placeholder="Username">
        <input id="pass" type="password" placeholder="Passphrase">
        <input id="in" type="submit" value="Sign In">
        <input id="up" type="button" value="Sign Up">
    </form>

    <div id="your-files-section" class="section">
        <h2>Your Files</h2>
        <ul id="file-list"></ul>
    </div>

    <div id="add-file-section" class="section">
        <h2>Add Audio File</h2>
        <form id="add-file">
            <input type="file" id="file" accept="audio/*">
            <input type="submit" value="Add File">
        </form>
    </div>

    <div id="search-section" class="section">
        <h2>Search by Public Key</h2>
        <input id="search" placeholder="Enter public key">
    </div>

    <div id="found-files-section" class="section">
        <h2>Files Found by Public Key</h2>
        <ul id="search-file-list"></ul>
    </div>

    <div id="pub-key-section" class="section">
        <h2>Your Public Key</h2>
        <p id="pub-key"></p>
    </div>

    <button id="logout" style="display: none;">Logout</button>

    <!-- Dependencies for basic utilities -->
    <script src="https://cdn.jsdelivr.net/npm/gun/examples/jquery.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <!-- Dependencies from SEA-sample.html code -->
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/yson.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/dom.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/upload.js"></script>

    <script>
        var gun = Gun();
        var user = gun.user();

        // Recall the user from session storage if available
        user.recall({sessionStorage: true});

        $('#up').on('click', function(e){
            user.create($('#alias').val(), $('#pass').val());
        });

        $('#sign').on('submit', function(e){
            e.preventDefault();
            user.auth($('#alias').val(), $('#pass').val());
        });

        $('#logout').on('click', function(e){
            user.leave();
            $('#sign').show();
            $('#logout').hide();
            $('#add-file-section').hide();
            $('#search-section').hide();
            $('#your-files-section').hide();
            $('#found-files-section').hide();
            $('#pub-key-section').hide();
            $('#file-list').empty();
            $('#search-file-list').empty();
            $('#pub-key').text('');
        });

        $('#add-file').on('submit', function(e) {
            e.preventDefault();
            var file = $('#file')[0].files[0];
            if (!file) return;

            var reader = new FileReader();
            reader.onload = function(event) {
                var fileData = event.target.result;
                var fileName = file.name;

                user.get('files').set({
                    name: fileName,
                    data: fileData,
                    type: file.type
                });
            };
            reader.readAsDataURL(file);
        });

        function sanitizeId(id) {
            return id.replace(/[^\w-]/g, '');
        }

        function displayFile(file, id, isOwner = true) {
            if (!file || !file.data) {
                console.error('Invalid file:', file);
                return;
            }
            var sanitizedId = sanitizeId(id);
            var $li = $('#' + sanitizedId);
            if ($li.length === 0) {
                $li = $('<li>').attr('id', sanitizedId);
                var audio = $('<audio controls>').attr('src', file.data);
                $li.append(file.name);
                $li.append(audio);
                if (isOwner) {
                    var deleteButton = $('<button>').text('Delete').on('click', function() {
                        user.get('files').get(id).put(null); // Remove the file from GUN
                    });
                    $li.append(deleteButton);
                    $('#file-list').append($li);
                } else {
                    $('#search-file-list').append($li);
                }
            } else {
                $li.find('audio').attr('src', file.data);
            }
        }

        function removeFile(id) {
            var sanitizedId = sanitizeId(id);
            $('#' + sanitizedId).remove();
        }

        function loadExistingFiles() {
            user.get('files').map().on(function(file, id) {
                if (file) { // Filter out null values
                    displayFile(file, id);
                } else {
                    removeFile(id); // Remove the file from the UI
                }
            });
        }

        gun.on('auth', function(){
            $('#sign').hide();
            $('#logout').show();
            $('#add-file-section').show();
            $('#search-section').show();
            $('#your-files-section').show();
            $('#found-files-section').show();
            $('#pub-key-section').show();
            $('#file-list').empty(); // Clear the existing list to avoid duplicates
            $('#search-file-list').empty(); // Clear the search list
            loadExistingFiles(); // Load existing files and set up real-time updates

            // Display user's public key
            var pub = user._.sea.pub;
            $('#pub-key').text(pub);
        });

        // Function to search for a user by public key and display their files
        $('#search').on('input', function(e){
            var pubKey = $(this).val();
            var targetUser = gun.user(pubKey);
            $('#search-file-list').empty(); // Clear the list before displaying new files
            targetUser.get('files').map().on(function(file, id) {
                if (file) { // Filter out null values
                    displayFile(file, id, false);
                } else {
                    removeFile(id); // Remove the file from the UI
                }
            });
        });
    </script>
</body>
</html>
